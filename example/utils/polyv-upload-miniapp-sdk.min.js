(function(global,e){"object"===typeof exports&&"undefined"!==typeof module?module.exports=e():"function"===typeof define&&define.amd?define(e):(global=global||self,global.polyv=e())})(this,function(){"use strict";function e(e,t){return t={exports:{}},e(t,t.exports),t.exports}var t=e(function(e,t){var i=Object.prototype.hasOwnProperty;var s=t.extend=Object.assign||function(e){if(null==e)throw new Error("target cannot be null");var t=0,s=arguments.length,r,a;while(++t<s){a=arguments[t];if(null!=a)for(r in a)if(i.call(a,r))e[r]=a[r]}return e};var r=Object.prototype.toString;var a=t.isFunction=function(e){return"[object Function]"===r.call(e)};t.isDate=function(e){return"[object Date]"===r.call(e)};t.isObject=function(e){return"[object Object]"===r.call(e)};t.isEmptyObject=function(e){if(null!=e)for(var t in e)if(i.call(e,t))return false;return true};t.each=function(e,t){if(null!=e){var s,r=e.length;if(void 0===r||a(e)){for(s in e)if(i.call(e,s)&&false===t.call(e[s],e[s],s))break}else{s=-1;while(++s<r)if(false===t.call(e[s],e[s],s))break}}return e};t.toArray=function(e){var t;try{t=Array.prototype.slice.call(e)}catch(s){t=[];var i=e.length;while(i)t[--i]=e[i]}return t};t.mergeArray=function(e,t){var i=t.length,s=e.length,r=0;while(r<i)e[s++]=t[r++];e.length=s;return e};t.randomStr=function(e){var t="";do{t+=Math.random().toString(36).substr(2)}while(t.length<10);t=t.substr(0,10)+("00000"+Math.abs(new Date)).slice(-6);if(e)t=e+t;return t};t.createClass=function(e,t,r,a){var o=r?function(){r.apply(this,a?"function"===typeof a?a.apply(this,arguments):a:arguments);e.apply(this,arguments)}:function(){e.apply(this,arguments)};if(r){var n=function(){};n.prototype=r.prototype;o.prototype=new n;o.prototype.constructor=o;s(o,r)}if(t)for(var l in t)if(i.call(t,l))o.prototype[l]=t[l];return o}});var i=t.extend;var s=t.isFunction;var r=t.isDate;var a=t.isObject;var o=t.isEmptyObject;var n=t.each;var l=t.toArray;var u=t.mergeArray;var c=t.randomStr;var h=t.createClass;function d(){return false}function p(){return true}var f=t.createClass(function(e,i){var s=this;t.extend(s,i);s.type=e;s.timeStamp=+new Date},{preventDefault:function(){this.isDefaultPrevented=p},stopPropagation:function(){this.isPropagationStopped=p},isDefaultPrevented:d,isPropagationStopped:d});var m=function(e){var t={};this.trigger=function(e,i,s){var r=new f(e,i);var a=t[e];if(a)for(var o=0;o<a.length;o++)a[o].call(s||this,r);return r};this.on=function(e,i){t[e]=t[e]||[];t[e].push(i);return this};this.off=function(e,i){switch(arguments.length){case 0:t={};break;case 1:delete t[e];break;case 2:var s=t[e];if(s){for(var r=s.length-1;r>=0;r--)if(s[r]===i)s.splice(r,1);if(!s.length)delete t[e]}break}return this};if(e)for(var i in e)if(e.hasOwnProperty(i)&&e[i])this.on(i,e[i])};const g={request(e,t={},i="GET"){if(!e)console.warn("!!request url can not be empty");return new Promise((s,r)=>{wx.request({url:e,method:i,data:t,header:{"content-type":"application/x-www-form-urlencoded"},success(e){s(e.data)},fail(e){r(e)}})})}};function v(e,t){const i={ptime:e.ptime,sign:e.sign,hash:e.hash,title:t.title,describ:t.desc,cataid:t.cataid,tag:t.tag,luping:t.luping,keepsource:t.keepsource,filesize:t.filesize,state:t.state,autoid:1,uploadType:"vod_miniapp_sdk_v1",compatible:1};const s=`https://api.polyv.net/v2/uploadvideo/direct/${e.userid}/init`;return g.request(s,i,"POST")}function _(e){const{sign:t,ptime:i,hash:s,userid:r}=e;const a={ptime:i,sign:t,hash:s,compatible:1};const o=`https://api.polyv.net/v2/uploadvideo/${r}/token`;return g.request(o,a)}function w(e){const{file:t}=e;return new Promise((e,i)=>{wx.getFileInfo({filePath:t.path,success(t){e(t.digest)},fail(e){i(e)}})})}function y(e){if(e&&"string"===typeof e){e=e.trim();e=e.replace(/<.+?>/g,"")}return e}async function b(e,t,i){const s={desc:"",cataid:1,tag:"",luping:0,keepsource:0,title:e.name.replace(/\.\w+$/,""),filename:e.name};for(const e in t)if("title"===e){if("string"!==typeof t.title||""===t.title.replace(/(^\s*)|(\s*$)/,""))continue;s.title=y(t.title)}else s[e]=t[e];Object.defineProperty(s,"file",{value:e,writable:false,enumerable:false,configurable:false});Object.defineProperty(s,"size",{value:e.size,writable:false,enumerable:false,configurable:false});Object.defineProperty(s,"filesize",{value:e.size,writable:false,enumerable:false,configurable:false});const r=await w(s);Object.defineProperty(s,"id",{value:r,writable:false,enumerable:false,configurable:false});return s}function P(){return"https:"}function D(e){const t="https:";if("string"!==typeof e||""===e.trim())return"";if(/^http/.test(e))return e.replace("http:",t);else if(/^\/\//.test(e))return`${t}${e}`;return e}function k(e){const t=P();return{endpoint:t+"//"+e.domain,bucket:e.bucketName,accessKeyId:e.accessId,accessKeySecret:e.accessKey,stsToken:e.token,secure:"https:"===t,cname:true}}const T="video/avi,.avi,.f4v,video/mpeg,.mpg,video/mp4,.mp4,video/x-flv,.flv,video/x-ms-wmv,.wmv,video/quicktime,.mov,video/3gpp,.3gp,.rmvb,video/x-matroska,.mkv,.asf,.264,.ts,.mts,.dat,.vob,audio/mpeg,.mp3,audio/x-wav,.wav,video/x-m4v,.m4v,video/webm,.webm,.mod";function L(e,t){const i=t.split(",");return i.indexOf(e.type)>-1||i.indexOf(e.name.replace(/.+(\..+)$/,"$1").toLowerCase())>-1}function S(e,t){const i=L(e,T);const s=t?L(e,t):true;return i&&s}const C="网络错误，请检查网络后重试";class E extends m{constructor(e,t,i={},s={}){super(i);this.userData=e;this.fileData=t;this.parallel=s.threadCount;this.partSize=s.partSize;this.retryCount="number"===typeof s.retryCount?s.retryCount:3;this.statusCode=1;this.percentage=0;this.id=t.id;this.isDeleted=false}addRejectListener(e){this.reject=e}addResolveListener(e){this.resolve=e}updateFileData(e){for(const t in e)if("title"===t){if("string"!==typeof e.title||""===e.title.replace(/(^\s*)|(\s*$)/,""))continue;this.fileData.title=y(e.title)}else this.fileData[t]=e[t]}_start(){if(2===this.statusCode){this.statusCode=0;return this._Upload()}this.statusCode=0;const{userData:e,fileData:t}=this;return v(e,t).then(e=>{const i=e.data;if(200!==e.code){this._emitFileFailed({code:e.code,message:e.message,type:"InitUploadError"});return Promise.resolve({data:{uploader:this},code:101,message:e.message})}if(t.size>i.remainSpace)return Promise.resolve({data:{id:this.id,uploader:this},code:102,message:"您的剩余空间不足，请及时联系客服升级空间"});this.fileData.vid=i.vid;this.trigger("FileStarted",{uploaderid:this.id,fileData:t});const s=t.file.name;this.ossConfig=i;this.filenameOss=i.dir+i.vid+s.substring(s.lastIndexOf("."));return this._Upload()}).catch(e=>{this._emitFileFailed({code:"",message:e.message,type:"UploadError"});return Promise.resolve({data:{uploader:this},code:101,message:C})})}_Upload(){return new Promise((e,t)=>{const i=this;const{ossConfig:s,filenameOss:r}=this;const{host:a,signature:o,accessid:n,policy:l,callback:u}=s;const c=this.fileData.file.path;const h=this.uploadTask=wx.uploadFile({url:D(a),filePath:c,name:"file",formData:{key:r,policy:l,OSSAccessKeyId:n,signature:o,callback:u},success:t=>{if(204===t.statusCode||200===t.statusCode){i._finish();return e({code:100,message:`${this.fileData.title}完成上传`,data:{id:this.id}})}},fail:s=>{if("uploadFile:fail abort"==s.errMsg){s.name="cancel";s.status=0}return i._handleUploadError(s,e,t)}});h.onProgressUpdate(e=>{i._updateProgress(e.progress)})})}_handleUploadError(e,t,i){if(0===e.status&&"cancel"===e.name){if(!this.isDeleted)this.trigger("FileStopped",{uploaderid:this.id,fileData:this.fileData});return t({code:104,message:"暂停上传",data:{uploader:this}})}if(404==e.status&&"NoSuchUploadError"==e.name){if(this.retryCount>0)return this._retry(t);this._emitFileFailed({code:"",message:e.message,type:"NoSuchUploadError"});return t({data:{uploader:this},code:105,message:"Upload ID 不存在"})}if(this.retryCount>0)return this._retry(t);this._emitFileFailed({code:"",message:e.message,type:e.name});return t({data:{uploader:this},code:101,message:C})}_retry(e){this.retryCount--;return e({code:107,message:"上传错误，正在重试",data:{uploader:this}})}_updateToken(e,t){_(this.userData).then(t=>{if("success"!==t.status){this._emitFileFailed({code:"",message:t.message,type:"UpdateTokenError"});return e({data:{uploader:this},code:101,message:C})}this.ossConfig=k(t.data);return e({code:106,message:"token过期，正在重试",data:{promise:this._Upload()}})}).catch(e=>{this._emitFileFailed({code:"",message:"接口请求失败",type:"UpdateTokenError"});return t(e)})}_emitFileFailed(e){this.trigger("FileFailed",{uploaderid:this.id,errData:e,fileData:this.fileData})}_stop(){if(0!==this.statusCode)return this.resolve();this.statusCode=2;if(!this.uploadTask)return this.resolve();this.uploadTask.abort()}_finish(){this.statusCode=-1;this.percentage=1;this.trigger("FileSucceed",{uploaderid:this.id,fileData:this.fileData})}_updateProgress(e){this.percentage=e;this.trigger("FileProgress",{uploaderid:this.id,progress:e,fileData:this.fileData})}}class F{constructor(){this._list=[]}get list(){return this._list.slice()}get size(){return this._list.length}enqueue(e){this._list.push(e)}unshift(e){this._list.push(e)}clear(){this._list=[]}dequeue(){return this._list.shift()}_findIndexById(e){let t=-1;const i=this.size;for(let s=0;s<i;s++)if(e===this._list[s].id){t=s;break}return t}find(e){const t=this._findIndexById(e);return t>-1?this._list[t]:null}remove(e){const t=this._findIndexById(e);return t>-1?this._list.splice(t,1)[0]:null}}const O={WAITING_LIST:"waitingList",PROCESSING_LIST:"processingList"};class I{constructor(e,t){this._runTask=e;this._limit=t;this._waitingList=[];this._processingList=[]}get size(){return this._waitingList.length+this._processingList.length}enqueue(e){return new Promise((t,i)=>{this._waitingList.push({id:e.id,task:e,resolve:t,reject:i});e.addRejectListener(i);e.addResolveListener(t);this._check()})}dequeue(){if(this._processingList.length>0)return this._processingList.shift().task;return this._waitingList.shift().task}remove(e){let t=this._processingListRemove(e);if(!t)t=this._waitingListRemove(e);return t?t.task:null}_removeItem(e,t){const i=t===O.PROCESSING_LIST;const s=i?this._processingList:this._waitingList;let r=-1;let a=null;const o=s.length;for(let t=0;t<o;t++)if(e===s[t].id){r=t;break}if(r>-1){a=s.splice(r,1)[0];if(i)this._check()}return a}_waitingListRemove(e){return this._removeItem(e,O.WAITING_LIST)}_processingListRemove(e){return this._removeItem(e,O.PROCESSING_LIST)}_run(e){this._runTask(e.task).then(t=>{this._processingListRemove(e.id);e.resolve(t)}).catch(t=>e.reject(t)).finally(()=>{this._check()})}_check(){const e=this._processingList.length;const t=this._limit-e;this._waitingList.slice(0,t).forEach(e=>{this._waitingListRemove(e.id);this._processingList.push(e);this._run(e)})}}const U="vod-miniapp-sdk-1.0.0";console.info(U);const x={NOT_STARTED:"notStarted",UPLOADING:"uploading"};class A extends m{constructor(e={}){super(e.events);this.config={partSize:e.partSize,threadCount:e.threadCount,retryCount:e.retryCount,acceptedMimeType:e.acceptedMimeType};let t=e.parallelFileLimit||5;if(t<0||t>5)t=5;this.fileQueue=new F;this.waitQueue=new F;this.uploadPool=new I(e=>e._start(),t);this.userData={};this.newUploadPromiseList=[];this.status=x.NOT_STARTED}updateUserData(e){for(const t in e)this.userData[t]=e[t]}updateFileData(e,t){if("object"!==typeof t)return;const i=this.waitQueue.find(e);if(!i||1!==i.statusCode){this._emitError({code:112,message:"文件已经开始上传或已上传完毕，禁止修改文件信息",data:{uploaderid:e}});return}i.updateFileData(t)}async addFile(e,t={},i={}){const s=await b(e,i,this.userData);if(this.fileQueue.find(s.id)){this._emitError({code:110,message:"文件重复",data:{filename:s.title}});return null}if(!S(e,this.config.acceptedMimeType)){this._emitError({code:111,message:"文件类型错误",data:{filename:s.title}});return null}this.fileQueue.enqueue(s);const r=new E(this.userData,s,t,this.config);if(this.status===x.NOT_STARTED)this.waitQueue.enqueue(r);else this.newUploadPromiseList.push(this.uploadPool.enqueue(r));return r}removeFile(e){const t=this.uploadPool.remove(e);if(t){t.isDeleted=true;t._stop()}else this.waitQueue.remove(e);this.fileQueue.remove(e)}resumeFile(e){const t=this.waitQueue.remove(e);if(!t)return;this.newUploadPromiseList.push(this.uploadPool.enqueue(t));if(this.status===x.NOT_STARTED)this._onPromiseEnd()}stopFile(e){const t=this.uploadPool.remove(e);if(t){t._stop();this.waitQueue.enqueue(t)}}clearAll(){this._stopAll(true);this.waitQueue.clear();this.fileQueue.clear()}startAll(){while(this.waitQueue.size>0){const e=this.waitQueue.dequeue();if(-1!==e.statusCode)this.newUploadPromiseList.push(this.uploadPool.enqueue(e))}this.status=x.UPLOADING;this._onPromiseEnd()}stopAll(){this._stopAll()}_stopAll(e=false){while(this.uploadPool.size>0){const t=this.uploadPool.dequeue();if(e)t.isDeleted=true;t._stop();if(1===t.statusCode)this.waitQueue.enqueue(t)}this.status=x.NOT_STARTED}_onPromiseEnd(){const e=[...this.newUploadPromiseList];this.newUploadPromiseList=[];Promise.all(e).then(()=>{if(this.newUploadPromiseList.length>0)this._onPromiseEnd();else if(0===this.uploadPool.size){this.status=x.NOT_STARTED;if(0===this.waitQueue.size&&0!==this.fileQueue.size)this.trigger("UploadComplete")}});for(let t=0;t<e.length;t++)e[t].then(e=>{if(!e||!e.code)return;this._handleUploadStatusChange(e)}).catch(e=>{this._emitError(e)})}_handleUploadStatusChange(e){const t=e.data;switch(e.code){case 100:this.waitQueue.remove(t.id);break;case 102:this.waitQueue.unshift(t.uploader);this._emitError(e);break;case 101:case 104:case 105:if(t.uploader&&!t.uploader.isDeleted)this.waitQueue.unshift(t.uploader);break;case 106:case 107:this.newUploadPromiseList.push(this.uploadPool.enqueue(t.uploader));if(this.status===x.NOT_STARTED)this._onPromiseEnd();break;default:break}}_emitError(e){this.trigger("Error",e)}get files(){return this.fileQueue.list}}return A});
